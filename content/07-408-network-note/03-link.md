---
author: xnzone 
title: 数据链路层 
date: 2023-02-27 10:04:00
image: /covers/network.jpg
cover: false
math: true
weight: 10
tags: ["王道408", "计算机网络","数据链路层"]
---

## 功能概述

结点：主机、路由

链路：网络中两个结点之间的物理通道

数据链路：网络中两个结点之间的逻辑通道

帧：链路层的协议数据单元，封装网络层数据报

### 功能

负责通过一条链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报

为网络层提供服务，无确认无连接服务，有确认无连接服务，有确认面向连接服务（有连接一定有确认）

链路管理，即连接的建立、维持、释放（用于面向连接的服务）

组帧

流量控制

差错控制（帧错/位错）

## 封装成帧和透明传输

### 封装成帧

封装成帧就是在一段数据的前后部分添加首部和尾部，这样就形成了一个帧

接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束

首部和尾部包含许多控制信息，他们的一个重要作用：帧定界（确定帧的界限）

帧同步：接收方应当能从接收到的二进制比特流中区分出帧的起始和终止

组帧的四种方式：1.字符计数法，2.字符(节)填充法，3.零比特填充法，4.违规编码法

### 透明传输

透明传输是指不管所传数据是什么养的比特组合，都应当能够在链路上传送

因此，链路层就看不见有什么妨碍数据传输的东西

当所传数据中的比特组合恰巧与某一个控制信息完全一样时，就必须采取适当的措施，使接收方不会将这样的数据误认为使某种控制信息。这样才能保证数据链路层的传输时透明的

### 字符计数法

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-byte-cnt.jpg)

### 字符填充法

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-byte-fill-1.jpg)

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-byte-fill-2.jpg)

ESC就是一个转义字符

### 零比特填充

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-zero-fill.jpg)

### 违规编码法

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-mess-code.jpg)

## 差错控制(检错编码)

### 差错来源

传输中的差错都是由于噪声引起的，分为全局性和局部性噪音

全局性：由于线路本身电器特性所产生的随机噪声(热噪声)，是信道固有的，随机存在的

解决办法：提高信噪比来减少或避免干扰(对传感器下手)

局部性：外界特定的短暂原因所造成的冲击噪声，是产生差错的主要原因

解决办法：通常利用编码技术来解决

### 差错的分类

- 位错：比特位出错，1变0，0变1
- 帧错：丢失，重复，失序

### 位错的差错控制

**检错编码**

- 奇偶校验码：奇校验-1的个数为奇数，偶校验-1的个数位偶数
- CRC循环冗余码：FCS的生成以及接收端CRC校验都是由硬件实现，处理很迅速，因此不会延误数据传输

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-crc-1.jpg)

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-crc-2.jpg)

**纠错编码**

- 海明校验码


## 差错控制(纠错编码)

海明距离：两个合法编码(码字)的对应比特取值不同的比特数称为这两个码字的海明距离(码距)。一个有效编码集中，任意两个合法编码(码字)的海明距离的最小值称为该编码集的海明距离(码距)

### 海明校验过程

- 确定校验码位数r
- 确定校验码和数据的位置
- 求出校验码的值
- 检错并纠错

**确定校验码位数r**

数据/信息有m位，冗余码/校验码有r位

校验码一共有2^r种取值

2^r >= m + r + 1

**确定校验码和数据的位置**

校验码放在序号2^n的位置，数据按序填上

|序号|7|6|5|4|3|2|1|
|---|---|---|---|---|---|---|---|
|值｜1｜1｜0｜$x_4$|0||$x_2$|$x_1$|

**求出校验码的值**

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-haiming-solve.jpg)

**检错并纠错**

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-haiming-valid.jpg)

## 流量控制与可靠传输机制

### 流量控制

较高的发送速度和较低的接收能力的不匹配，回造成传输出错，因此流量控制也是数据链路层的一项重要工作

数据链路层的流量控制是点对点的，而传输层的流量控制是端到端的

数据链路层流量控制手段：接收方瘦不下就不回复确认

传输层流量控制手段：接收端给发送端一个窗口公告

### 流量控制方法

停止等待协议：每次发送完一个帧就停止发送，等待对方确认，在收到确认后再发送下一个帧。（效率低）发送窗口大小=1，接收窗口大小=1

滑动窗口协议：分为后退N帧协议(GBN)和选择重传协议(SR)

后退N帧协议：发送窗口大小>1，接收窗口大小=1

选择重传协议：发送窗口大小>1，接收窗口大小>1


### 可靠传输

发送端发啥，接收端收啥

### 流量控制

控制发送速率，使接收方有足够的缓冲空间来接收每一个帧

### 滑动窗口解决

流量控制(收不下就不给确认，想发也发不了)

可靠传输(发送方自动重传)


## 停止-等待协议

### 为什么要有停止等待协议

1. 除了比特位发生差错，底层信道回发生丢包问题
2. 为了实现流量控制

丢包：物理线路故障、设备故障、病毒攻击、路由信息错误等

### 研究停等协议的前提

虽然现在常用全双工通信方式，但为了讨论问题方便，仅考虑一方发送数据（发送方），一方接收数据（接收方）

因为是讨论可靠传输的原理，所以并不考虑数据是在哪一个层次上传送的

停止-等待就是每次发完一个分组就停止发送，等待对方确认，在收到确认后再发送下一个分组

### 无差错情况

每发送1个数据帧就停止等待，因此用1bit来编号就够了

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-stop-wait-noerror.jpg)

### ACK：确认帧

数据帧丢失或检测到帧出错

发送完一个帧后，必须保留他的副本

数据帧和确定帧必须编号

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-stop-wait-ack.jpg)


### ACK丢失

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-stop-wait-ack-lost.jpg)

### ACK迟到

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-stop-wait-ack-later.jpg)

### 性能分析

简单但是信道利用率太低

信道利用率：发送方在一个发送周期内，有效的发送数据所需要的时间占整个发送周期的比例

信道吞吐率=信道利用率*发送方发送速率

信道利用率=$(L/C)/T$ L是T内发送L比特数据，C是发送方数据传输率，T是发送周期

## 回退N帧协议

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-gnb.jpg)

### GBN发送方必须响应的三件事

1. 上层的调用
2. 收到了一个ACK
3. 超时事件

**上层的调用**

上层要发送数据时，发送方显检查发送窗口是否已满。如果未满，则产生一个帧将其发送；如果已满，发送方只需要将数据返回给上层，暗示上层窗口已满，上层等会儿再发送（实际实现，发送方可以缓存这些数据，窗口不满时再发送)

**收到了一个ACK**

GBN协议中，对n号帧的确认采用累积确认的方式，表明接收方已经收到n号帧和它之前的全部帧

**超时事件**

协议的名字为后退N帧/回退N帧，来源于出现丢失和时延过长帧时发送方的行为。

就像在停等协议中一样，如果出现超时，发送方重传所有已发送但未被确认的帧

### 接收方要做的事情

1. 收到正确的n号帧，并且按序，那么接收方为n帧发送一个ACK，并将数据交付给上层
2. 其余情况都丢弃帧，并为最近按序接收的帧重新发送ACK。接收方无需暂存任何失序帧，只要维护一个信息：expectedseqnum(下一个按序接收的帧序号)

### 运行中的GBN

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-gbn-run.jpg)

### 滑动窗口长度

若采用n个比特对帧编号，那么发送窗口的尺寸WT应满足：$1 \le WT \le 2n-1$。因为发送窗口尺寸过大，就会使得接收方无法区分新帧和旧帧

### 重点总结

- 累积确认(偶尔捎带确认)
- 接收方只按顺序接收帧，不按序则抛弃
- 确认序列号最大的，按序到达的帧
- 发送窗口最大为 2^n-1，接收窗口大小为1

### 性能分析

优点：因连续发送数据帧而提高了信道利用率

缺点：在重传时必须把原来已经正确传送的数据帧重传，使传送效率降低

## 选择重传协议(SR)

解决GBN的缺点：设置单个确认，同时加大接收窗口，设置接收缓存，缓存乱序到达的帧

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-sr.jpg)

### SR发送方必须响应的三件事

1. 上层调用
2. 收到一个ACK
3. 超时事件

**上层调用**

从上层收到数据后，SR发送方检查下一个可用于该帧的序号。如果序号位于发送窗口内，则发送数据帧；否则像GBN一样，要么将数据缓存，要么返回给上层之后再传输

**收到了一个ACK**

如果收到ACK，假如该帧序号在窗口内，则SR发送方将哪个被确认的帧标记为已接收。如果该帧序号是窗口的下界(最左边第一个窗口对应的序号)，则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发送帧，则发送帧

**超时事件**

每个帧都有自己的定时器，一个超时事件只重传一个帧

### SR接收方要做的事

1. SR接收方将确认一个正确接收的帧而不管其是否按序
2. 失序的帧将被缓存，并返回给发送方一个该帧的确认帧(收谁确认谁)。直到所有帧(即序号更小的帧)皆被收到为止，这时才可以将一批帧按序交付给上层，然后向前移动滑动窗口
3. 如果收到了窗口序号为小于窗口下界的帧，就返回一个ACK，其他情况就忽略该帧

### 运行中的SR

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-link-sr-run.jpg)

### 滑动窗口长度

发送窗口最好等于接收窗口(大了会溢出，无法判断是重传还是开始的帧，小了没意义)

W发送窗口=W接收窗口=2^(n-1)

### 重点总结

- 对数据帧逐一确认，收到一个确认一个
- 只重传出错帧
- 接收方有缓存
- W发送窗口=W接收窗口=2^(n-1)


## 信道划分介质访问控制

### 传输数据使用的两种链路

点对点链路：两个相邻结点通过一个链路相连，没有第三者。应用：PPP协议，常用于广域网

广播式链路：所有主机共享通信介质。应用：早期的总线以太网、无线局域网，常用于局域网，典型拓扑结构：总线型、星型(逻辑总线型)

### 介质访问控制

采取一定的措施，使得两对结点之间的通信不会发生互相干扰的情况。主要有静态划分信道和动态分配信道

**静态划分信道**

信道划分介质访问控制，主要有

- 频分多路复用 FDM
- 时分多路复用 TDM
- 波分多路复用 WDM
- 码分多路复用 CDM

**动态分配信道**

- 轮询访问介质：令牌传递协议
- 随机访问介质控制访问：ALOHA协议、CSMA协议
、SCMA/CD协议、CSMA/CA协议




