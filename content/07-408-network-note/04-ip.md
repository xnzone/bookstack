---
author: xnzone 
title: 网络层 
date: 2023-02-27 10:04:00
image: /covers/network.jpg
cover: false
math: true
weight: 11
tags: ["王道408", "计算机网络","网络层"]
---

## 功能概述

主要任务是把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务

网络层传输单位是数据报

### 功能

1. 路由选择与分组转发
2. 异构网络互联
3. 拥塞控制：开环控制(静态)，闭环控制(动态)

若所有节点都来不及接受分组，而要丢弃大量分组的话，网络就处于拥塞状态。因此需要采取措施，缓解拥塞

## IP数据报格式

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-ip-data-format.jpg)

- 1B=8b
- 版本：IPv4/IPv6
- 首部长度：单位是4B，最小为5
- 区分服务：指示期望获得哪种类型的服务
- 总长度：首部+数据，单位是1B
- 生存空间(TTL): IP分组的保质期。经过一个路由-1，变成0则丢弃
- 协议：数据部分的协议
- 首部校验和：只校验首部
- 源IP地址和目的IP地址：3892位
- 可选字段：0～40B，用来支持排错、测量以及安全措施
- 填充：全0，把首部补成4B的整数倍


**数据部分的协议**

|协议名|ICMP|IGMP|TCP|EGP|IGP|UDP|IPv6|ESP|OSPF|
|---|---|---|---|---|---|---|---|---|---|
|字段值|1|2|6|8|9|17|41|50|89|


## IP数据报分片

### 最大传送单元MTU

链路层数据帧可封装数据的上限

以太网的MTU时1500字节

如果传输的数据报长度大于MTU，就需要分片

### 数据报格式

标识：同一数据报的分片使用同一标识

标志：只有2位有意义：DF,MF

中间位DF(Don't Fragment)：DF=1，禁止分片；DF=0，允许分片

最低位MF(More Fragment)：MF=1，后面还有分片；MF=0，代表最后一片/没有分片

片偏移：指出较长分组分片后，某分片在原分组中的相对位置(以8B为单位，除了最后一个分片，每个分片长度一定是8B的整数倍)

单位：总长度单位是1B，片偏移单位是8B，首部长度单位是4B

## IPv4地址

### IP编址的历史阶段

分类的IP地址

子网划分

构成超网(五分类编址方法)

### 分类的IP地址

IP地址：全世界唯一的32位/4字节标识符，标识路由器主机的接口

IP地址：={<网络号>,<主机号>}

|网络类别|最大可用网络数|第一个可用的网络号|最后一个可用的网络号|每个网络中最大的主机数|
|---|---|---|---|---|
|A| $2^7-2$ | 1 | 126 | $2^{24} - 2$|
|B| $2^{14}-1$ | 128.1|191.255|$2^{16}-2$|
|C| $2^{21}-1$| 192.0.1|223.255.255| $2^8-1$|

## 网络地址转换(NAT)

Network Address Translation，在专用网连接到因特网的路由器上安装NAT软件，安装了NAT软件的路由器叫NAT路由器，它至少有一个有效的外部全球IP地址

## 子网划分和子网掩码

### 分类的IP地址的弱点

IP地址空间的利用率有时很低

两级IP地址不够灵活

### 子网划分

某单位划分子网后，对外仍表现为一个网络，即本单位外的网络看不见本单位内子网的划分

两级IP地址：网络号+主机号

三级IP地址：网络号+子网号+主机号

### 子网掩码

两级IP地址：145.13.3.10

两级IP地址的子网掩码：255.255.0.0

三级IP地址：145.13.3.10

三级IP地址的子网掩码：255.255.255.0

子网的网络地址：145.13.3.0(IP地址和子网掩码与操作)

### 使用子网时分组的转发

**路由表中**

目的网络地址

目的网络子网掩码

下一跳地址

**路由器转发分组的算法**

提取目的IP地址

是否直接嚼服(逐位相与)

特定主机路由

检测路由表中有无路径(逐位相与)

默认路由0.0.0.0(回到第一步循环)

丢弃，报告转发分组出错

## 无分类编址CIDR

为什么使用CIDR：B类地址很快将分配完毕，路由表中的项目急剧增长


### CIDR的特点

消除了传统A类，B类和C类地址以及划分子网的概念

融合子网地址与子网掩码，方便子网划分

CIDR把网络前缀相同的连续的IP地址组成一个CIDR地址块。如128.14.35.7/20是某CIDR地址块中的一个地址，20表示网络前缀长度

两级IP地址：网络号+主机号

三级IP地址：网络号+子网号+主机号

CIDR地址：网络前缀(网络号+子网号) + 主机号

### 构成超网

将多个子网聚合成一个较大的子网，叫做构成超网，或路由聚合

方法：将网络前缀缩短(所有网络地址取交集)

### 最长前缀匹配

使用CIDR时，查找路由表可能得到几个匹配结果(跟网络掩码按位相与)，应选择具有最长网络前缀的路由

前缀越长，地址块越小，路由越具体


## ARP协议

### 发送数据过程

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-ip-send-data.jpg)

### 为什么要使用ARP协议

由于在实际网络的链路上传送数据帧时，最终必须使用MAC地址

ARP协议王城主机或路由IP地址到MAC地址的映射(解决下一跳走哪的问题)

ARP协议是自动进行的

### ARP协议使用过程

检查ARP高速缓存，有对应表则写入MAC帧

没有则用目的MAC地址为FF-FF-FF-FF-FF-FF的帧封装并广播ARP请求分组，同一局域网中所有主机都能收到该请求

目的主机收到请求后就会向源主机单播一个ARP响应分组，源主机收到后，将此映射写入ARP高速缓存(10~20min更新一次)

### ARP协议4种典型情况

1. 主机A发送给本网络上的主机B：用ARP找到主机B的硬件地址
2. 主机A发送给另一网络上的主机B：用ARP找到本网络上一个路由器(网关)的硬件地址
3. 路由器发给本网络的主机A：用ARP找到主机A的硬件地址
4. 路由器发给另一网络的主机B：用ARP找到本网络上的一个路由器的硬件地址

## DHCP协议

### 主机如何获得IP地址

静态配置：IP地址，子网掩码，默认网关

动态配置：用DHCP服务器来分配IP

### 定义

动态主机配置协议DHCP是应用层协议，使用客户/服务器方式，客户端和服务端通过广播方式进行交互，基于UDP

DHCP提供即插即用的联网机制，主机可以葱服务器动态获取IP地址，子网掩码，默认网关，DNS服务器名称和IP地址。允许地址重用，支持移动用户加入网络，支持在用地址续租

### 工作流程

主机广播DHCP发现报文(试图找到网络中的服务器，服务器获得一个IP地址)

DHCP服务器广播DHCP提供报文(服务器拟分配给主机一个IP地址及相关配置，先到先得)

主机广播DHCP请求报文(主机向服务器请求提供IP地址)

DHCP服务器广播DHCP确认报文(正式将IP地址分配给主机)


## ICMP协议

![](https://jihulab.com/xnzone/earth-bear/-/raw/master/network-ip-icmp.jpg)

### ICMP差错报文(五种)

终点不可达：当路由器或主机不能交付数据报时，就向源点发送终点不可达报文(无法交付)

源点抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。(拥塞丢数据，现在已经被遗弃了)

时间超过：当路由器收到生存时间TTL=0的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到以个数报的全部数据报片时，就把已收到的数据片都丢弃，并向源点发送时间超过报文(TTL=0)

参数问题：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文(首部字段有问题)

改变路由(重定向):路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)

### 不应发送ICMP差错报文的情况

对ICMP差错报告报文不再发送ICMP差错报告报文

对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文

对具有组播地址的数据报都不发送ICMP差错报告报文

对具有特殊地址(如127.0.0.0或0.0.0.0)的数据报不发送ICMP差错报告报文

### ICMP询问报文

**回送请求和回答报文**

主机或路由向特定目的主机发出询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文

测试目的站是否可达以及了解其相关状态

ping + 域名

**时间戳请求和回答报文**

请某个主机或路由回答当前的时间和日期

用来进行时钟同步和测量时间


**掩码地址请求和回答报文(被遗弃)**

**路由询问和通告报文(被遗弃)**

### ICMP的应用

PING：测试两个主机之间的连通性，使用ICMP回送请求和回答报文

Traceroute: 跟踪一个分组从源点到终点的路径，使用ICMP时间超过差错报告报文

## IPv6

